name: Auto Create Issues

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create-issue-from-commit:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, '[ISSUE]') ||
      contains(github.event.head_commit.message, '[TODO]') ||
      contains(github.event.head_commit.message, '[BUG]') ||
      contains(github.event.head_commit.message, '[FEATURE]')
    
    steps:
      - name: Extract issue info from commit
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessage = context.payload.head_commit.message;
            const commitUrl = context.payload.head_commit.url;
            
            let title = '';
            let body = '';
            let labels = ['auto-created'];
            
            if (commitMessage.includes('[BUG]')) {
              title = commitMessage.replace('[BUG]', '').trim() || 'Bug reported in commit';
              body = `## Auto-Created Bug Report
            
This issue was automatically created from a commit message that mentioned "[BUG]".
            
**Commit:** ${commitMessage}
**Commit URL:** ${commitUrl}
**Branch:** ${context.ref}
**Commit Author:** ${context.payload.head_commit.author.name}
**Timestamp:** ${context.payload.head_commit.timestamp}

---
            
This issue needs more context. Please update the description with additional details about the bug.`;
              labels.push('bug', 'needs-triage');
            } else if (commitMessage.includes('[FEATURE]')) {
              title = commitMessage.replace('[FEATURE]', '').trim() || 'Feature request from commit';
              body = `## Auto-Created Feature Request
            
This issue was automatically created from a commit message that mentioned "[FEATURE]".
            
**Commit:** ${commitMessage}
**Commit URL:** ${commitUrl}
**Branch:** ${context.ref}
**Commit Author:** ${context.payload.head_commit.author.name}
**Timestamp:** ${context.payload.head_commit.timestamp}

---
            
This issue needs more context. Please update the description with additional details about the feature request.`;
              labels.push('enhancement', 'needs-triage');
            } else if (commitMessage.includes('[TODO]') || commitMessage.includes('[ISSUE]')) {
              title = commitMessage.replace(/\[(TODO|ISSUE)\]/, '').trim() || 'Task from commit';
              body = `## Auto-Created Task
            
This issue was automatically created from a commit message that mentioned "[TODO]" or "[ISSUE]".
            
**Commit:** ${commitMessage}
**Commit URL:** ${commitUrl}
**Branch:** ${context.ref}
**Commit Author:** ${context.payload.head_commit.author.name}
**Timestamp:** ${context.payload.head_commit.timestamp}

---
            
This issue needs more context. Please update the description with additional details about the task.`;
              labels.push('task', 'needs-triage');
            }
            
            return { title, body, labels };

      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { title, body, labels } = steps.extract.outputs;
            
            // Check if issue already exists with similar title
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const duplicateIssue = existingIssues.data.find(issue => 
              issue.title === title && !issue.title.includes('Auto-Created')
            );
            
            if (duplicateIssue) {
              console.log('Issue already exists:', duplicateIssue.html_url);
              return;
            }
            
            // Create the issue
            const response = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
            
            console.log('Created issue:', response.data.html_url);

  create-issue-from-failed-tests:
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Create Issue for Failed Tests
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸ”´ Tests Failing in ${context.ref}`;
            const body = `## Auto-Created Issue: Test Failures
            
This issue was automatically created because tests are failing in the latest push.
            
**Branch:** ${context.ref}
**Commit:** ${context.sha}
**Workflow Run:** ${context.payload.repository.html_url}/actions/runs/${context.runId}

### Failed Job
- **Job Name:** ${context.job}
- **Runner:** ${context.runner}

### Next Steps
1. Check the failing tests in the workflow log
2. Fix the underlying issues
3. Ensure all tests pass before merging

---
            
*This issue will be automatically closed when tests are passing again.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'testing', 'auto-created']
            });

  create-issue-from-security-advisories:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, '[SECURITY]') ||
      contains(github.event.head_commit.message, '[SECURITY-FIX]')
    
    steps:
      - name: Create Security Issue
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessage = context.payload.head_commit.message;
            const title = commitMessage.replace(/\[(SECURITY|SECURITY-FIX)\]/, '').trim() || 'Security issue reported';
            
            const body = `## Auto-Created Security Issue
            
This security issue was automatically created from a commit message that mentioned "[SECURITY]".
            
**Commit:** ${commitMessage}
**Commit URL:** ${context.payload.head_commit.url}
**Branch:** ${context.ref}
**Commit Author:** ${context.payload.head_commit.author.name}
**Timestamp:** ${context.payload.head_commit.timestamp}

### Security Priority
ðŸ”’ **HIGH PRIORITY** - This requires immediate attention.

### Next Steps
1. Review the security implications
2. Verify the fix is complete
3. Consider disclosure timeline
4. Update security documentation if needed

---
            
*This issue requires urgent review and attention.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] ${title}`,
              body: body,
              labels: ['security', 'high-priority', 'needs-review']
            });

  close-auto-created-issues:
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Close Auto-Created Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Close auto-created issues that are resolved
            const autoIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-created',
              per_page: 100
            });
            
            for (const issue of autoIssues.data) {
              // Close test failure issues if tests are now passing
              if (issue.title.includes('ðŸ”´ Tests Failing')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  body: issue.body + '\n\n---\n\nâœ… **RESOLVED** - Tests are now passing!'
                });
              }
            }